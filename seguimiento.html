<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <title>Nab&uacute</title>
    <meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=no">
    <script src="js/util.js"></script>
    <script src="js/tween.min.js"></script>
    <script src="js/dictionary.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="styles.css">
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
    <script>
        var usuario;
        var offsetX = 0;
        var offsetY = 0;
        var operativo;
        var col = 300;
        var row = 130;
        var scale = window.innerWidth / 1920;
        var zoom = scale;
        var grupoParam;
        var arbolPersonal;
        var lastMouse = null;
        var editando = false;

        //var operativo = {
        //    objetivo: 'xxxxx', URLEstatuto: 'xxx',
        //    gruposTrabajo: [
        //        { nombre: 'g1', procesos: [{ nombre: 'p1' }, { nombre: 'p2' }, { nombre: 'p3' }], publis: [{ nombre: 'p1' }, { nombre: 'p2' }, { nombre: 'p3' }] },
        //        { nombre: 'g2', procesos: [{ nombre: 'p1' }, { nombre: 'p2' }, { nombre: 'p3' }], publis: [{ nombre: 'p1' }, { nombre: 'p2' }, { nombre: 'p3' }] },
        //        { nombre: 'g3', procesos: [{ nombre: 'p1' }, { nombre: 'p2' }, { nombre: 'p3' }], publis: [{ nombre: 'p1' }, { nombre: 'p2' }, { nombre: 'p3' }] },
        //    ]
        //};

        $(document).mousemove(function (event) {
            if (!editando) {
                if (event.which == 1 && !event.ctrlKey) {
                    //scroll
                    if (lastMouse) {
                        offsetX -= lastMouse.clientX - event.clientX;
                        offsetY -= lastMouse.clientY - event.clientY;
                        //document.body.style.cursor = "all-scroll";
                        event.preventDefault();
                        transform();
                    }
                    lastMouse = { clientX: event.clientX, clientY: event.clientY };
                }
                else if (event.which == 1 && event.ctrlKey) {
                    //zoom
                    if (lastMouse) {
                        zoom += (lastMouse.clientX - event.clientX) * 2 / window.innerWidth;
                        //document.body.style.cursor = "w-resize";
                        event.preventDefault();
                        dibujarTodo();
                    }
                    lastMouse = { clientX: event.clientX, clientY: event.clientY };
                }
                else {
                    if (lastMouse)
                        event.preventDefault(); //fin
                    lastMouse = null;
                    //document.getElementById("todo").style.cursor = "default";
                }
                //$("div").text(event.which + ", " + event.ctrlKey);
            }
        });

        function transform() {
            var g = document.getElementById("grupo");
            var matrix0 = document.getElementById("todo").createSVGMatrix();
            matrix0 = matrix0.translate(offsetX, offsetY);
            if (g.transform.baseVal.numberOfItems == 0)
                g.transform.baseVal.appendItem(g.transform.baseVal.createSVGTransformFromMatrix(matrix0));
            else
                g.transform.baseVal.getItem(0).setMatrix(matrix0);
        }

        function doLoad() {
            //obtengo datos de los parametros
            grupoParam = getParameterByName('grupo');
            if (grupoParam && grupoParam != "" && grupoParam != "null") {
                //leo cookie
                var cookie = getCookie("nabu-" + grupoParam);
                if (cookie == "")
                    //login normal
                    document.location = 'default.html?grupo=' + grupoParam;
                else {
                    calcularResize();

                    //cargo datos iniciales
                    var vals = cookie.split("|");
                    usuario = { nombre: vals[0], email: vals[1], clave: vals[2], grupo: vals[3], isAdmin: vals[4], idioma: vals[5] };

                    idioma = vals[5]; //para el tradcutor

                    if (!usuario) {
                        //login normal
                        document.location = 'default.html';
                    }
                    else
                        getHttp("doMain.aspx?actn=getOperativo&email=" + usuario.email
                            + "&grupo=" + usuario.grupo
                            + "&clave=" + usuario.clave,
                             function (data) {
                                //atrapo el error si es que hay
                                if (data.substring(0, 6) == "Error=") {
                                    //ha habido un error
                                    document.getElementById("todo").innerHTML = '<font color=red>' + data + '</font>';
                                }
                                else {
                                    //tengo el bosque
                                    //document.getElementById("todo").innerHTML = data;
                                    operativo = JSON.parse(data);
                                    dibujarTodo();
                                }
                            });
                }
            }
            else
                //login normal
                document.location = 'default.html?grupo=' + grupoParam;
        }

        function calcularResize() {
            var scalex = window.innerWidth / 1920;
            var scaley = window.innerHeight / 1080;
            document.getElementById("todo").style.top = '0px';
            document.getElementById("todo").style.left = '0px';
            document.getElementById("todo").style.width = window.innerWidth + 'px';
            document.getElementById("todo").style.height = window.innerHeight + 'px';
            document.getElementById("joystick").style.top = (window.innerHeight - 190) + 'px';

            //titulo
            document.getElementById("titulo").style.left = (window.innerWidth - 280) + 'px';
            document.getElementById("titulo0").style.fontSize = (50 * scaley).toFixed(0) + 'px';
            document.getElementById("titulo1").style.fontSize = (30 * scaley).toFixed(0) + 'px';
            document.getElementById("titulo2").style.fontSize = (25 * scaley).toFixed(0) + 'px';
            document.getElementById("titulo").style.visibility = "visible";

            //atras
            document.getElementById("atras").style.width = (100 * scalex) + 'px';
            document.getElementById("atras").style.height = (100 * scaley).toFixed(0) + 'px';
            //background
            document.body.style.backgroundSize = window.innerWidth + 'px ' + window.innerHeight + 'px';
        }

        function dibujarTodo() {
            var scalex = window.innerWidth / 1920;
            var scaley = window.innerHeight / 1080;
            var s = "";
            s += "<defs>";
            s += "<marker id='markerCircle' markerWidth='8' markerHeight='8' refX='5' refY='5'>";
            s += "<circle cx='5' cy='5' r='3' style='stroke: none; fill:#000000;opacity:0.4;'/>";
            s += "</marker>";
            s += "<marker id='markerArrow' markerWidth='20' markerHeight='20' refX='2' refY='6' orient='auto'>";
            s += "<path d='M2,2 L2,11 L10,6 L2,2' style='fill: #000000;opacity:0.4' />";
            s += "</marker>";
            s += "</defs>";

            s += "<text x='" + (50 + 100 * scalex) + "' y='" + (10 + 100 * scaley / 2 + 10) + "' fill='black' style='font-size:30px'>"
                + usuario.grupo + " - " + tr("Seguimiento") + "</text>";
            s += "<g id='grupo'>";
            s += dibujarSeguimiento(operativo, 100 + col / 2 + offsetX, 150 + offsetY, zoom);
            s += "</g>"

            document.getElementById("todo").innerHTML = s;
        }

        function dibujarSeguimiento(operativo, x, y, zoom) {
            //manifiesto
            var zrow = row * zoom;
            var zcol = col * zoom;
            var s = "";

            //acciones
            for (i in operativo.acciones) {
                var ac = operativo.acciones[i];

                var acX = x + i * zcol + 10;
                var acY = y;
                s += caja(ac.nombre, ac.estado, ac.estadoTs, acX, acY, "#4169E1", zoom, "openAC(" + i + ");");
            }
            return s;
        }

        function caja(nombre, estado, estadoTs, x, y, color, zoom, onclick) {
            var boxWidth = col * 0.8 * zoom;
            var boxHeight = row * 0.8 * zoom;
            var nom = nombre;
            if (nom.length > 15)
                nom = nom.substring(0, 15) + "...";

            var s = "<rect x='" + (x - boxWidth / 2).toFixed(0) + "' y='" + (y - boxHeight / 2).toFixed(0) + "' rx='20' ry='20' ";
            s += "width='" + boxWidth.toFixed(0) + "' height='" + boxHeight.toFixed(0) + "' ";
            s += "style='cursor:pointer;fill:" + color + ";stroke:black;stroke-width:" + (5 * zoom).toFixed(0) + ";opacity:0.4' ";
            s += "onclick=\"" + onclick + "\"/></rect>";

            s += "<text x='" + x.toFixed(0) + "' y='" + (y - boxHeight / 6).toFixed(0) + "' fill='cursor:pointer;black' style='font-size:" + (20 * zoom).toFixed(0) + "px' text-anchor='middle' ";
            s += "onclick=\"" + onclick + "\">";
            s += nom;
            s += "</text>";

            s += "<text x='" + x.toFixed(0) + "' y='" + (y - boxHeight / 6 + 20 * zoom).toFixed(0) + "' fill='cursor:pointer;black' style='font-size:" + (16 * zoom).toFixed(0) + "px' text-anchor='middle' ";
            s += "onclick=\"" + onclick + "\">";
            s += estado;
            s += "</text>";

            s += "<text x='" + x.toFixed(0) + "' y='" + (y - boxHeight / 6 + 40 * zoom).toFixed(0) + "' fill='cursor:pointer;black' style='font-size:" + (12 * zoom).toFixed(0) + "px' text-anchor='middle' ";
            s += "onclick=\"" + onclick + "\">";
            s += estadoTs;
            s += "</text>";
            return s;
        }

        function openAC(index) {
            editando = true;
            document.getElementById("AC").style.top = ((window.innerHeight - 600) / 2).toFixed(0) + 'px';
            document.getElementById("AC").style.left = ((window.innerWidth - 800) / 2).toFixed(0) + 'px';
            document.getElementById("AC").style.width = '800px';
            document.getElementById("AC").style.height = '600px';

            var s = "";
            var AC = operativo.acciones[index];
            s = "<b>" + tr("Accion") + ":</b> " + AC.nombre + "<br>";
            s += "<b>" + tr("Nacido") + ":</b> " + AC.born + "<br>";
            s += "<b>" + tr("Decision fecha") + ":</b> " + AC.docTs + "<br>";
            s += "<b>" + tr("Decision") + ":</b> <a href='" + AC.docURL + "' target='_blank'>" + getURLName(AC.docURL) + "</a><br>";
            s += "<b>" + tr("Objetivo") + ":</b><br> " + AC.objetivo + "<br>";
            s += "<b>" + tr("Estado") + ":</b> " + AC.estado + "<br>";
            s += "<b>" + tr("EstadoTs") + ":</b> " + AC.estadoTs + "<br>";
            s += "<br>";

            //cierre
            s += "<input type='button' class='btn' value='" + tr("Cerrar") + "' onclick='doCerrarDocumento();'>";
            if (usuario.email == operativo.admin) {
                s += "<input type='button' class='btn' value='" + tr("Finalizar") + "' onclick='doFinalizar(" + index + ");'>";
            }
            
            //estados
            s += "<b>Estados:</b><br>"
            for (var j in AC.estados) {
                var estado = AC.estados[j];
                s += "<b>" + estado.estadoTs + " - " + estado.estado + "</b><br>"
                s += estado.descrip + "<br>";
                s += "<hr>";
                s += "<br>";
            }

            //agregar estado
            if (usuario.email == operativo.admin) {
                //puede crear estados
                s += "<br><br><input type='text' id='nuevoEstado' class='editar' size=10><br>";
                s += "<textarea id='nuevoDescrip' class='editar' style='width:90%;height:150px'></textarea>"
            }

            if (usuario.email == operativo.admin) {
                s += "<input type='button' class='btn' value='" + tr("Agregar estado") + "' onclick='doAgregarEstado(" + index + ");'>";
                s += "<div id='msg'></div>";
            }
            document.getElementById("AC").innerHTML = s;
            document.getElementById("AC").style.visibility = "visible";

        }
          
        function doFinalizar(index) {
            var AC = operativo.acciones[index];
            getHttp("doMain.aspx?actn=organizacion&email=" + usuario.email
                + "&grupo=" + usuario.grupo
                + "&clave=" + usuario.clave
                + "&accion=accionFinalizar"
                + "&EID=" + AC.EID,
                 function (data) {
                     //atrapo el error si es que hay
                     if (data.substring(0, 6) == "Error=") {
                         //ha habido un error
                         document.getElementById("msg").innerHTML = '<font color=red>' + data + '</font>';
                     }
                     else {
                         document.getElementById("AC").innerHTML = "";
                         document.getElementById("AC").style.visibility = "hidden";
                         var respuesta = JSON.parse(data);
                         operativo = respuesta.operativo;
                         if (respuesta.resultado != 'ok')
                             document.getElementById("msgDiv").innerHTML = '<font color=red>' + data + '</font>';
                         dibujarTodo();
                         dibujarTodo();
                     }
                 });
        }

        function doAgregarEstado(index) {
            var AC = operativo.acciones[index];
            var nuevoEstado = document.getElementById("nuevoEstado");
            var nuevoDescrip = document.getElementById("nuevoDescrip");
            postHttp("doMain.aspx?actn=organizacion&email=" + usuario.email
                + "&grupo=" + usuario.grupo
                + "&clave=" + usuario.clave
                + "&accion=accionAddEstado"
                + "&EID=" + AC.EID
                + "&estado=" + nuevoEstado.value,
                "descrip=" + URIEncode(nuevoDescrip.value),
                 function (data) {
                     //atrapo el error si es que hay
                     if (data.substring(0, 6) == "Error=") {
                         //ha habido un error
                         document.getElementById("msgDiv").innerHTML = '<font color=red>' + data + '</font>';
                     }
                     else {
                         //tengo el bosque
                         //document.getElementById("todo").innerHTML = data;
                         var respuesta = JSON.parse(data);
                         operativo = respuesta.operativo;
                         if (respuesta.resultado != 'ok')
                            document.getElementById("msgDiv").innerHTML = '<font color=red>' + data + '</font>';
                         dibujarTodo();
                         openAC(index);
                     }
                 });
        }

        function doCerrarDocumento() {
            document.getElementById("AC").style.visibility = "hidden";
            editando = false;
        }

        function doAtras() {
            document.location = "default.html?grupo=" + grupoParam;
        }

    </script>
</head>
<body onload="doLoad();" style="overflow:hidden">
        <svg id="todo"  style="position: absolute;">
        </svg>
        <!--titulo--------------------------------------------------------------------------------------------------->
        <div id="titulo" style="visibility:hidden; padding: 10px; width: 250px; text-align:right; position: absolute; left:0px; top:0px;">
            <a href="help.html" target="_blank" style="color:black;text-decoration:none;">
                <div id="titulo0" class="titulo0" style="cursor: pointer;"><font color="blue" size="2">[?]</font><nobr>Nab&uacute;</nobr></div>
            </a>
            <div id="titulo1" class="titulo1"><nobr>Cooperativa 2.0</nobr></div>
            <div id="titulo2" class="titulo2"><nobr>Democracia interactiva</nobr></div>
            <div id="msgDiv" class="msg"></div>
        </div>

        <!--atras--------------------------------------------------------------------------------------------------->
        <img id="atras" class="btnimg" title="Atras" src="res/atras.png" style="visibility:visible; position: absolute; left:10px; top:10px;" onclick="doAtras();" />
    
        <!--joystick--------------------------------------------------------------------------------------------------->
        <div id="joystick" style="padding: 5px; text-align:right; position: absolute; left:10px; top:0px;">
            <table>
                <tr>
                    <td><img src="res/jzm.png" style='cursor:pointer;' onclick="zoom *= 1.1; dibujarTodo();"  /></td>
                    <td><img src="res/ju.png" style='cursor:pointer;' onclick="offsetY -= 30; transform();" /></td>
                    <td></td>
                </tr>
                <tr>
                    <td><img src="res/jl.png" style='cursor:pointer;' onclick="offsetX -= 30; transform();" /></td>
                    <td><img src="res/j00.png" style='cursor:pointer;' onclick="zoom = 1; offsetY = 0; offsetX = 0; dibujarTodo();" /></td>
                    <td><img src="res/jr.png" style='cursor:pointer;' onclick="offsetX += 30; transform();" /></td>
                </tr>
                <tr>
                    <td><img src="res/jzl.png" style='cursor:pointer;' onclick="if (zoom > 0.6) zoom *= 0.9; dibujarTodo();" /></td>
                    <td><img src="res/jd.png" style='cursor:pointer;' onclick="offsetY += 30; transform();" /></td>
                    <td></td>
                </tr>
            </table>
        </div>

        <!--GT--------------------------------------------------------------------------------------------------->
        <div id="AC" class="documento" style="fill:#4169E1;stroke:black;stroke-width:5;visibility:hidden;position:absolute;"></div>
    </body>
</html>