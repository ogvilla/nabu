

<!--//test WebGL-->

<html>
<head>
    <script src="js/three.min.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script>
        var gl; // Un variable global para el contexto WebGL
        var camera;
        var renderer;
        var scene;
        var firefoxWhich = 0;
        var lastMouse = null;
        var controls;
        var imgs = [];


        $(document).mouseup(function (event) {
            //document.getElementById("joystick").innerHTML = "mouseup.event.which: " + event.which;
            firefoxWhich = 0;
        });

        $(document).mousedown(function (event) {
            //document.getElementById("joystick").innerHTML = "mousedown.event.which: " + event.which;
            firefoxWhich = 1;
        });


        $(document).mousemove(function (event) {
            if (firefoxWhich == 1 && !event.ctrlKey) {
                //scroll
                if (lastMouse) {
                    var offsetY = lastMouse.clientY - event.clientY;
                    var offsetX = lastMouse.clientX - event.clientX;
                    event.preventDefault();
                    //camera.rotation.y -= offsetX / window.innerWidth;
                    //camera.rotation.x -= offsetY / window.innerHeight;
                    camera.position.x += offsetX;
                    camera.position.y += offsetY;
                    controls.update();
                }
                lastMouse = { clientX: event.clientX, clientY: event.clientY };
            }
            else {
                if (lastMouse)
                    event.preventDefault(); //fin
                lastMouse = null;
            }
            document.getElementById("msg").innerHTML = event.which + ", " + event.ctrlKey;
        });

        function doLoad() {
            loadImg('res/secretaria.png'); 
            loadImg('res/seguimiento.png');
            setTimeout(start, 1000);
        }

        function loadImg(src) {
            new THREE.ImageLoader()
                .setCrossOrigin('*')
                .load(src + '?' + performance.now(), function (image) {
                    pushCache(src, image);
                });
        }

        function start() {
            renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth - 30, window.innerHeight - 40);
            document.body.appendChild(renderer.domElement);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            controls = new THREE.OrbitControls(camera);
            camera.position.y = 1000;
            camera.position.z = 1000;
            controls.update();
            paint();

            //light
            var pointLight = new THREE.PointLight(0xFFFFFF);
            pointLight.position.x = 0;
            pointLight.position.y = 800;
            pointLight.position.z = 830;
            pointLight.lookAt(0,0,0);
            scene.add(pointLight);

            var AmbientLight = new THREE.AmbientLight(0x404040); // soft white light
            scene.add(AmbientLight);

            //plano
            //var geometry = new THREE.PlaneGeometry(3000, 3000);
            //var material = new THREE.MeshBasicMaterial({ color: 0xf0f0f0, side: THREE.DoubleSide, opacity: 0.5 });
            //var plane = new THREE.Mesh(geometry, material);
            //plane.rotation.x = 3.1415 / 2;
            //plane.position.y = -30;
            //scene.add(plane);

            //referencia
            //var lineMaterial = new THREE.LineBasicMaterial({ color: 0x101010, opacity: 1, linewidth: 23 });
            //var geometry = new THREE.Geometry();
            //geometry.vertices.push(new THREE.Vector3(0, 300, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(300, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, -300));
            //var referencia = new THREE.Line(geometry, lineMaterial);
            //scene.add(referencia);

            ////esfera
            //var sphereMaterial = new THREE.MeshLambertMaterial({color: 0xCC0000});
            //var sphere = new THREE.Mesh(new THREE.SphereGeometry(50, 16, 16), sphereMaterial);
            //sphere.position.z = -300;
            //scene.add(sphere);

            ////line
            //var lineMaterial = new THREE.LineBasicMaterial({ color: 0x101010, opacity: 1, linewidth: 23 });
            //var geometry = new THREE.Geometry(); 
            //geometry.vertices.push(new THREE.Vector3(-500, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 500, 0));
            //geometry.vertices.push(new THREE.Vector3(500, 0, 0));
            //var line = new THREE.Line(geometry, lineMaterial);
            //line.position.z = -300;
            //scene.add(line);

            //torus
            var grupo = {
                usuarios: 30, seguimientos: 20, hijos: [
                    { usuarios: 30, seguimientos: 20, hijos: [] },
                    { usuarios: 30, seguimientos: 20, hijos: [] },
                    { usuarios: 30, seguimientos: 20, hijos: [] }
                ]
            };
            grupo3D(0, 0, 0, 150, grupo, 0);


        }

        function grupo3D(x, y, z, radio, grupo, nivel) {
            //usuarios
            torus(x, y, z, radio, grupo.usuarios, "blue", "res/secretaria.png");

            //seguimientos
            torus(x, y, z, radio * 2, grupo.seguimientos, "red", "res/seguimiento.png");

            //hijos
            torus(x, y, z, radio * 3, grupo.hijos.length, "green", "");
            var Cini = new THREE.Vector3(x, y, z);
            var Prot = new THREE.Vector3(0, 0, radio * 6);
            for (var q = 0; q < grupo.hijos.length; q++) {
                if (nivel == 0)
                    Prot.y += 360 / grupo.hijos.length;
                else
                    Prot.y += 180 / grupo.hijos.length;
                var Chijo = VAdd(Cini, VPolToCar(Prot));
                grupo3D(Chijo.x, Chijo.y, Chijo.z, radio * 0.4, grupo.hijos[q], nivel + 1);
            }
        }

        function torus(x, y, z, radio, gajos, color, src) {

            //circle
            var gajos = gajos;
            var lineMaterial = new THREE.LineDashedMaterial({ color: color, opacity: 1, linewidth: 1 });
            var geometry = new THREE.Geometry();
            var Pini = new THREE.Vector3(0, 0, radio)
            var Prot = new THREE.Vector3(0, 0, -radio)
            var Cimg;
            for (var g = 0; g < gajos; g++) {
                Cimg = null;
                for (var q = 0; q < 360; q += 4) {
                    var Crot = VPolToCar(Prot);
                    var Cini = VPolToCar(Pini);
                    geometry.vertices.push(VAdd(Cini, Crot));
                    Prot.x += 4;
                    if (q == 180)
                        Cimg = VAdd(Cini, Crot); //guardo el centro para la imagen
                }
                Prot.y += 360 / gajos;
                Pini.y += 360 / gajos;
                //image
                if (src && Cimg) {
                    img(src, x + Cimg.x, y + Cimg.y, z + Cimg.z);
                }
            }
            var torus = new THREE.Line(geometry, lineMaterial);
            torus.position.x = x;
            torus.position.y = y;
            torus.position.z = z;
            scene.add(torus);
        }

        function img(src, x, y, z) {
            var oimg = getCache(src);
            if (oimg)
                img2(oimg, x, y, z);
            else {
                new THREE.ImageLoader()
                    .setCrossOrigin('*')
                    .load('res/secretaria.png?' + performance.now(), function (image) {
                        img2(image, x, y, z);
                    });
            }
        }

        function img2(image, x, y, z) {
            var texture = new THREE.CanvasTexture(image);
            var material = new THREE.MeshPhongMaterial({ side: THREE.DoubleSide, color: "transparent", map: texture });
            var geometry = new THREE.BoxBufferGeometry(image.width, image.height, 1);
            var mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, y, z);
            //mesh.rotation.set(90, 90, 180);
            scene.add(mesh);
        }

        function getCache(id) {
            for (i in imgs)
                if (imgs[i].id == id)
                    return imgs[i].image;
            return null;
        }

        function pushCache(id, image) {
            imgs.push({id: id, image: image});
        }

        function VAdd(v1, v2) {
            return new THREE.Vector3(v1.x + v2.x, v1.y + v2.y, v1.z + v2.z);
        }

        function VPolToCar(vector) {
            var ret = PolToCar(vector.x, vector.y, vector.z);
            return new THREE.Vector3(ret.x, ret.y, ret.z);
        }

        function VCarToPol(vector) {
            var ret = CarToPol(vector.x, vector.y, vector.z);
            return new THREE.Vector3(ret.x, ret.y, ret.z);
        }

        function PolToCar(lat, lon, radius) {
            var DEG2RAD = Math.PI / 180;
            var phi = (90 - lat) * DEG2RAD;
            var theta = (lon + 180) * DEG2RAD;

            return {
                x: -(radius * Math.sin(phi) * Math.sin(theta)),
                y: radius * Math.cos(phi),
                z: radius * Math.sin(phi) * Math.cos(theta),
            }
        }

        function CarToPol(x, y, z, radius) {
            var RAD2DEG = 180 / Math.PI;
            var lon = Math.atan2(x, -z) * RAD2DEG;
            var radius = Math.sqrt(x * x + z * z);
            var lat = Math.atan2(y, radius) * RAD2DEG;
            return { lon: lon, lat: lat, radius: radius };
        }

        function paint() {
            requestAnimationFrame(paint);
            renderer.render(scene, camera);
            //controls.update();
        }
    </script>
</head>
<body onload="doLoad()">
  <canvas id="glcanvas" width="100" height="100">
   Tu navegador parece no soportar el elemento HTML5 <code>&lt;canvas&gt;</code>.
  </canvas>
    <div id="msg"></div>
</body>
</html>