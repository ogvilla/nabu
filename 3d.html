

<!--//test WebGL-->

<html>
<head>
    <script src="js/three.min.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/util.js"></script>
    <script src="js/dictionary.js"></script>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script>
        var gl; // Un variable global para el contexto WebGL
        var camera;
        var renderer;
        var scene;
        var firefoxWhich = 0;
        var lastMouse = null;
        var controls;
        var cache = [];
        var bosque;
        var font;
        var scale = window.innerWidth / 1920;
        var generando = false;


        $(document).mouseup(function (event) {
            //document.getElementById("joystick").innerHTML = "mouseup.event.which: " + event.which;
            firefoxWhich = 0;
        });

        $(document).mousedown(function (event) {
            //document.getElementById("joystick").innerHTML = "mousedown.event.which: " + event.which;
            firefoxWhich = 1;
        });


        $(document).mousemove(function (event) {
            if (firefoxWhich == 1 && !event.ctrlKey) {
                //scroll
                if (lastMouse) {
                    if (ver == '3D') {
                        var offsetY = lastMouse.clientY - event.clientY;
                        var offsetX = lastMouse.clientX - event.clientX;
                        event.preventDefault();
                        //camera.rotation.y -= offsetX / window.innerWidth;
                        //camera.rotation.x -= offsetY / window.innerHeight;
                        camera.position.x += offsetX;
                        camera.position.y += offsetY;
                        controls.update();
                    }
                    else {
                    }
                }
                lastMouse = { clientX: event.clientX, clientY: event.clientY };
            }
            else {
                if (lastMouse)
                    event.preventDefault(); //fin
                lastMouse = null;
            }
            //document.getElementById("msg").innerHTML = event.which + ", " + event.ctrlKey;
        });

        function doLoad() {
            //cargo recursos
            loadImg('res/secretaria.png');
            loadImg('res/doc.png');
            loadImg('res/seguimiento.png');
            loadFont('fonts/helvetiker_regular.typeface.json');

            //wait
            document.getElementById("florWait").style.top = (window.innerHeight / 2 - 100).toFixed(0) + 'px';
            document.getElementById("florWait").style.left = (window.innerWidth / 2 - 98).toFixed(0) + 'px';
            document.getElementById("florWait").style.visibility = "visible";

            //espero carga de recursos
            load2();
        }

        function load2() {
            if (cache.length < 4)
                setTimeout(load2, 300);
            else {
                //recursos cargados
                //idioma
                idioma = getParameterByName('idioma');
                if (idioma == null) idioma = 'es';

                //obtengo datos de los parametros
                grupoParam = getParameterByName('grupo');
                if (grupoParam && grupoParam != "" && grupoParam != "null") {
                    //leo cookie
                    var cookie = getCookie("nabu-" + grupoParam);
                    if (cookie == "")
                        //login normal
                        document.location = 'default.html?grupo=' + grupoParam;
                    else {
                        var scalex = window.innerWidth / 1920;
                        var scaley = window.innerHeight / 1080;

                        //atras
                        document.getElementById("atras").style.width = (100 * scalex) + 'px';
                        document.getElementById("atras").style.height = (100 * scaley).toFixed(0) + 'px';
                        //background
                        document.body.style.backgroundSize = window.innerWidth + 'px ' + window.innerHeight + 'px';
                        document.body.style.backgroundImage = "url('res/background.jpg')";


                        //cargo datos iniciales
                        var vals = cookie.split("|");
                        usuario = { nombre: vals[0], email: vals[1], clave: vals[2], grupo: vals[3], isAdmin: vals[4], idioma: vals[5] };

                        idioma = vals[5]; //para el tradcutor

                        if (!usuario) {
                            //login normal
                            document.location = 'default.html?grupo=' + grupoParam;
                        }
                        else {
                            iniciar3D();
                            actualizarBosque();
                        }
                    }
                }
                else
                    //login normal
                    document.location = 'default.html?grupo=' + grupoParam;
            }
        }

        function loadImg(src) {
            new THREE.ImageLoader()
                .setCrossOrigin('*')
                .load(src + '?' + performance.now(), function (image) {
                    pushCache(src, image);
                });
        }

        function loadFont(src) {
            var loader = new THREE.FontLoader();
            loader.load(src + '?' + performance.now(), function (font) {
                pushCache(src, font);
            });
        }

        function actualizarBosque() {
            getBosque("getBosque");
        }

        function generarBosque() {
            getBosque("clearBosque");
        }

        function getBosque(accion) {
            getHttp("doMain.aspx?actn=" + accion + "&email=" + usuario.email
                + "&grupo=" + usuario.grupo
                + "&clave=" + usuario.clave,
                 function (data) {
                     //atrapo el error si es que hay
                     document.getElementById("florWait").style.visibility = "hidden";
                     if (data.substring(0, 6) == "Error=") {
                         //ha habido un error
                         document.getElementById("msg").innerHTML = '<font color=red>' + data + '</font>';
                     }
                     else {
                         //tengo el bosque
                         //document.getElementById("todo").innerHTML = data;
                         bosque = JSON.parse(data);

                         //dibujo
                         dibujar3D();
                     }
                 });
        }

        function iniciar3D() {
            renderer = new THREE.WebGLRenderer({ alpha: true });
            renderer.setSize(window.innerWidth - 30, window.innerHeight - 40);
            document.body.appendChild(renderer.domElement);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            controls = new THREE.OrbitControls(camera);
            camera.position.y = 1000;
            camera.position.z = 1000;
            controls.update();
            paint();

        }

        function dibujar3D() {
            var scalex = window.innerWidth / 1920;
            var scaley = window.innerHeight / 1080;

            generando = false;

            //limpio escena
            while (scene.children.length > 0) {
                scene.remove(scene.children[0]);
            }

            //light
            var pointLight = new THREE.PointLight(0xFFFFFF);
            pointLight.position.x = 0;
            pointLight.position.y = 800;
            pointLight.position.z = 830;
            pointLight.lookAt(0, 0, 0);
            scene.add(pointLight);

            var AmbientLight = new THREE.AmbientLight(0x404040); // soft white light
            scene.add(AmbientLight);

            //panelgrupo
            s = "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Grupos") + ":" + 0 + "</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Usuarios") + ":" + 0 + "</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;'><nobr>" + tr("Horizontalidad") + ":" + 0 + "%</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;cursor:pointer;color:blue;text-decoration: underline;' onclick='actualizarBosque();'><nobr>" + tr("Actualizar") + "</nobr></div>";
            s += "<div class='titulo3' style='margin: 0px;padding:0px;cursor:pointer;color:blue;text-decoration: underline;' onclick='generarBosque();'><nobr>" + tr("Generar") + "</nobr></div>";
            var panel = document.getElementById("panelGrupo");
            panel.innerHTML = s;
            panel.style.top = (170 * scale) + 'px';
            panel.style.visibility = 'visible';

            //plano
            //var geometry = new THREE.PlaneGeometry(3000, 3000);
            //var material = new THREE.MeshBasicMaterial({ color: 0xf0f0f0, side: THREE.DoubleSide, opacity: 0.5 });
            //var plane = new THREE.Mesh(geometry, material);
            //plane.rotation.x = 3.1415 / 2;
            //plane.position.y = -30;
            //scene.add(plane);

            //referencia
            //var lineMaterial = new THREE.LineBasicMaterial({ color: 0x101010, opacity: 1, linewidth: 23 });
            //var geometry = new THREE.Geometry();
            //geometry.vertices.push(new THREE.Vector3(0, 300, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(300, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 0, -300));
            //var referencia = new THREE.Line(geometry, lineMaterial);
            //scene.add(referencia);

            ////esfera
            //var sphereMaterial = new THREE.MeshLambertMaterial({color: 0xCC0000});
            //var sphere = new THREE.Mesh(new THREE.SphereGeometry(50, 16, 16), sphereMaterial);
            //sphere.position.z = -300;
            //scene.add(sphere);

            ////line
            //var lineMaterial = new THREE.LineBasicMaterial({ color: 0x101010, opacity: 1, linewidth: 23 });
            //var geometry = new THREE.Geometry(); 
            //geometry.vertices.push(new THREE.Vector3(-500, 0, 0));
            //geometry.vertices.push(new THREE.Vector3(0, 500, 0));
            //geometry.vertices.push(new THREE.Vector3(500, 0, 0));
            //var line = new THREE.Line(geometry, lineMaterial);
            //line.position.z = -300;
            //scene.add(line);

            //torus
            //var grupo = {
            //    usuarios: 30, seguimientos: 20, hijos: [
            //        { usuarios: 30, seguimientos: 20, hijos: [] },
            //        { usuarios: 30, seguimientos: 20, hijos: [] },
            //        { usuarios: 30, seguimientos: 20, hijos: [] }
            //    ]
            //};
            grupo3D(0, 0, 0, 150, bosque, 0);

            if (generando)
                setTimeout(actualizarBosque, 1000);
        }

        function grupo3D(x, y, z, radio, nodo, nivel) {
            if (!nodo.descargado)
                generando = true;
            else {
                //usuarios
                torus(x, y, z, radio, nodo.usuarios, 0, "blue", "res/secretaria.png");

                //seguimientos
                torus(x, y, z, radio * 2, nodo.seguimientos, 0, "red", "res/doc.png");

                //hijos
                torus(x, y, z, radio * 3, nodo.hijos, nivel, "green", "");
                var Cini = new THREE.Vector3(x, y, z);
                var Prot = new THREE.Vector3(0, 0, radio * 6);
                for (var q = 0; q < nodo.hijos.length; q++) {
                    if (nivel == 0)
                        Prot.y += 360 / nodo.hijos.length;
                    else
                        Prot.y += 180 / nodo.hijos.length;
                    var Chijo = VAdd(Cini, VPolToCar(Prot));
                    grupo3D(Chijo.x, Chijo.y, Chijo.z, radio * 0.4, nodo.hijos[q], nivel + 1);
                }
            }
        }

        function torus(x, y, z, radio, gajos, nivel, color, src) {
            //circle
            var lineMaterial = new THREE.LineDashedMaterial({ color: color, opacity: 1, linewidth: 1 });
            var geometry = new THREE.Geometry();
            var Pini = new THREE.Vector3(0, 0, radio)
            var Prot = new THREE.Vector3(0, 0, -radio)
            var Cimg;
            for (var g = 0; g < gajos.length; g++) {
                Cimg = null;

                //incremento gajos
                if (nivel == 0) {
                    Prot.y += 360 / gajos.length;
                    Pini.y += 360 / gajos.length;
                }
                else {
                    Prot.y += 180 / gajos.length;
                    Pini.y += 180 / gajos.length;
                }

                //dibujo gajo
                for (var q = 0; q < 360; q += 4) {
                    var Crot = VPolToCar(Prot);
                    var Cini = VPolToCar(Pini);
                    geometry.vertices.push(VAdd(Cini, Crot));
                    Prot.x += 4;
                    if (q == 180)
                        Cimg = VAdd(Cini, Crot); //guardo el centro para la imagen
                }

                //image (si hay)
                if (src && Cimg) {
                    img(src, x + Cimg.x, y + Cimg.y, z + Cimg.z);
                    text(gajos[g].nombre, 20, x + Cimg.x, y + Cimg.y + 25, z + Cimg.z);
                }
            }
            var torus = new THREE.Line(geometry, lineMaterial);
            torus.position.x = x;
            torus.position.y = y;
            torus.position.z = z;
            scene.add(torus);
        }

        function text(s, size, x, y, z) {
            var font = getCache('fonts/helvetiker_regular.typeface.json');
            var shapes = font.generateShapes(s, size, 2);
            var geometry = new THREE.ShapeGeometry(shapes);
            var material = new THREE.MeshBasicMaterial({
                color: "black",
                transparent: true,
                opacity: 0.8,
                side: THREE.DoubleSide
            });
            geometry.computeBoundingBox();
            var bb = geometry.boundingBox;
            var text = new THREE.Mesh(geometry, material);
            text.position.x = x - (bb.max.x - bb.min.x) / 2;
            text.position.y = y;
            text.position.z = z;
            scene.add(text);
        }

        function img(src, x, y, z) {
            var image = getCache(src);
            var texture = new THREE.CanvasTexture(image);
            var material = new THREE.MeshBasicMaterial({ side: THREE.DoubleSide, color: "transparent", map: texture });
            var geometry = new THREE.BoxBufferGeometry(image.width, image.height, 1);
            var mesh = new THREE.Mesh(geometry, material);
            mesh.position.set(x, y, z);
            //mesh.rotation.set(90, 90, 180);
            scene.add(mesh);
        }

        function getCache(id) {
            for (i in cache)
                if (cache[i].id == id)
                    return cache[i].res;
            return null;
        }

        function pushCache(id, res) {
            cache.push({id: id, res: res});
        }

        function VAdd(v1, v2) {
            return new THREE.Vector3(v1.x + v2.x, v1.y + v2.y, v1.z + v2.z);
        }

        function VPolToCar(vector) {
            var ret = PolToCar(vector.x, vector.y, vector.z);
            return new THREE.Vector3(ret.x, ret.y, ret.z);
        }

        function VCarToPol(vector) {
            var ret = CarToPol(vector.x, vector.y, vector.z);
            return new THREE.Vector3(ret.x, ret.y, ret.z);
        }

        function PolToCar(lat, lon, radius) {
            var DEG2RAD = Math.PI / 180;
            var phi = (90 - lat) * DEG2RAD;
            var theta = (lon + 180) * DEG2RAD;

            return {
                x: -(radius * Math.sin(phi) * Math.sin(theta)),
                y: radius * Math.cos(phi),
                z: radius * Math.sin(phi) * Math.cos(theta),
            }
        }

        function CarToPol(x, y, z, radius) {
            var RAD2DEG = 180 / Math.PI;
            var lon = Math.atan2(x, -z) * RAD2DEG;
            var radius = Math.sqrt(x * x + z * z);
            var lat = Math.atan2(y, radius) * RAD2DEG;
            return { lon: lon, lat: lat, radius: radius };
        }

        function paint() {
            requestAnimationFrame(paint);
            renderer.render(scene, camera);
            //controls.update();
        }

        function doAtras() {
            document.location = "default.html?grupo=" + grupoParam;
        }
    </script>
</head>
<body onload="doLoad()">
        <img id="florWait" src="res/florWait.gif" style="visibility: hidden;position:absolute;" />
        <!--atras--------------------------------------------------------------------------------------------------->
        <img id="atras" class="btnimg" title="Atras" src="res/atras.png" style="visibility:visible; position: absolute; left:10px; top:10px;" onclick="doAtras();" />
        <!--panel grupo--------------------------------------------------------------------------------------------------->
        <div id="panelGrupo"  class="borde" style="visibility:hidden; padding: 5px; position: absolute; left:10px; top:110px; width:110px; color: gray; border: 1px solid gray; margin: 0px;">
        </div>
        <canvas id="glcanvas" width="100" height="100">
        Tu navegador parece no soportar el elemento HTML5 <code>&lt;canvas&gt;</code>.
        </canvas>
        <div id="msg"></div>
</body>
</html>